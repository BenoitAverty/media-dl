- hosts: docker
  remote_user: root
  become: yes
  become_user: docker
  vars_files:
    - secrets.yml
  tasks:
    - name: Necessary folders
      file:
        path: "{{item}}"
        state: directory
      with_items:
        - ~/stacks
        - /var/swarm-data/config/media-dl/sonarr
        - /var/swarm-data/config/media-dl/nzbget
        - /var/swarm-data/config/media-dl/torrent
        - /var/download-data/work/nzbget/completed
        - /var/download-data/work/torrent/completed
        - /var/download-data/work/torrent/incoming
        - /var/download-data/work/torrent/watched
        - /var/download-data/TV
    - name: Copy config files
      copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        force: no
      with_items:
        - { src: ./config/sonarr.xml, dest: /var/swarm-data/config/media-dl/sonarr/config.xml }
        - { src: ./config/nzbget.conf, dest: /var/swarm-data/config/media-dl/nzbget/nzbget.conf }
        - { src: ./config/torrent/, dest: /var/swarm-data/config/media-dl/torrent/ }
    - name: Copy stack file
      copy:
        src: ./media-dl.yml
        dest: ~/stacks/media-dl.yml
    - name: Stack deployment
      command: docker stack deploy -c ~/stacks/media-dl.yml media-dl
